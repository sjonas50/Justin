{% extends "base.html" %}

{% block title %}AI Investment Suggestions{% endblock %}

{% block extra_css %}
<style>
    .suggestion-section {
        margin-bottom: 30px;
    }
    
    .suggestion-section h3 {
        color: #667eea;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 2px solid #f0f0f0;
    }
    
    .suggestion-list {
        list-style: none;
        padding: 0;
    }
    
    .suggestion-list li {
        background: #f8f9fa;
        padding: 15px;
        margin-bottom: 10px;
        border-radius: 8px;
        border-left: 4px solid #667eea;
        transition: transform 0.2s ease;
    }
    
    .suggestion-list li:hover {
        transform: translateX(5px);
        background: #f0f1f3;
    }
    
    .back-button {
        margin-bottom: 20px;
    }
    
    .ai-disclaimer {
        background: #fef3c7;
        border: 1px solid #fbbf24;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
    }
    
    .ai-disclaimer p {
        margin: 0;
        color: #92400e;
    }
    
    #chat-container {
        max-height: 400px;
        overflow-y: auto;
        padding: 20px;
        background-color: #f8f9fa;
        border-radius: 8px;
        margin-bottom: 20px;
    }
    
    .message {
        margin-bottom: 15px;
        padding: 15px;
        border-radius: 8px;
        animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .user-message {
        background-color: #e3f2fd;
        margin-left: 20%;
        border-left: 4px solid #2196f3;
    }
    
    .assistant-message {
        background-color: #f3e5f5;
        margin-right: 20%;
        border-left: 4px solid #9c27b0;
    }
    
    .chat-form {
        display: flex;
        gap: 10px;
    }
    
    .chat-input {
        flex: 1;
    }
</style>
{% endblock %}

{% block content %}
<div class="back-button">
    <a href="{{ url_for('portfolio') }}" class="btn btn-secondary">‚Üê Back to Portfolio</a>
</div>

<div class="card">
    <div class="card-header">
        <h2>AI Investment Suggestions</h2>
    </div>
    
    <div class="ai-disclaimer">
        <p><strong>Disclaimer:</strong> These suggestions are generated by AI and should not be considered as professional financial advice. Always consult with a qualified financial advisor before making investment decisions.</p>
    </div>
    
    <div class="suggestion-content">
        {% if suggestions %}
            <ul class="suggestion-list">
                {% for suggestion in suggestions %}
                    {% if suggestion and suggestion.strip() %}
                        <li>{{ suggestion }}</li>
                    {% endif %}
                {% endfor %}
            </ul>
        {% else %}
            <p>No suggestions available at this time. Please ensure your portfolio and profile information are complete.</p>
        {% endif %}
    </div>
</div>

<div class="card mt-3">
    <div class="card-header">
        <h3>Chat with AI Advisor</h3>
    </div>
    
    <div id="chat-container">
        <div class="message assistant-message">
            <strong>AI Advisor:</strong> Hello! I'm here to help answer any questions about your portfolio or investment strategy. What would you like to know?
        </div>
    </div>
    
    <form id="chat-form" class="chat-form">
        <input type="text" id="user-input" name="user_input" class="form-control chat-input" placeholder="Ask a question about your investments..." required>
        <button type="submit" class="btn btn-primary">Send</button>
    </form>
</div>

<div class="card mt-3">
    <div class="card-header">
        <h3>Next Steps</h3>
    </div>
    
    <div class="flex gap-2">
        <a href="{{ url_for('portfolio') }}" class="btn btn-primary">Manage Portfolio</a>
        <button class="btn btn-secondary" onclick="window.print()">Print Suggestions</button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function() {
        // Get user's name from suggestions context
        const userName = '{{ name }}' || 'User';
        
        // Submit the chat form using AJAX
        $('#chat-form').submit(function(event) {
            event.preventDefault();
            const userInput = $('#user-input').val();
            
            // Display the user's message
            const userMessage = `<div class="message user-message"><strong>${userName}:</strong> ${userInput}</div>`;
            $('#chat-container').append(userMessage);
            
            // Show loading state
            const loadingMessage = '<div class="message assistant-message" id="loading"><strong>AI Advisor:</strong> <span class="spinner"></span> Thinking...</div>';
            $('#chat-container').append(loadingMessage);
            
            // Scroll to bottom
            $('#chat-container').scrollTop($('#chat-container')[0].scrollHeight);
            
            $.ajax({
                url: '/chat',
                method: 'POST',
                data: { user_input: userInput },
                success: function(response) {
                    // Remove loading message
                    $('#loading').remove();
                    
                    // Display the generated response
                    const assistantMessage = `<div class="message assistant-message"><strong>AI Advisor:</strong> ${response}</div>`;
                    $('#chat-container').append(assistantMessage);
                    $('#user-input').val('');
                    
                    // Scroll to the bottom of the chat container
                    $('#chat-container').scrollTop($('#chat-container')[0].scrollHeight);
                },
                error: function() {
                    $('#loading').remove();
                    const errorMessage = '<div class="message assistant-message"><strong>AI Advisor:</strong> Sorry, I encountered an error. Please try again.</div>';
                    $('#chat-container').append(errorMessage);
                }
            });
        });
    });
    
    // Add print-friendly styles
    const printStyles = document.createElement('style');
    printStyles.innerHTML = `
        @media print {
            .header, .back-button, .card:last-child, #chat-form {
                display: none;
            }
            .card {
                box-shadow: none;
                border: 1px solid #ddd;
            }
        }
    `;
    document.head.appendChild(printStyles);
</script>
{% endblock %}